<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_body" inherit_id="project_milestone_time_report.report_body">
        <!-- Start and End date -->
        <xpath expr="//table[hasclass('o_project_report__content')]/thead/tr[1]/th[1]" position="after">
            <th class="text-right">Start</th>
            <th class="text-right">End</th>
        </xpath>   
        <xpath expr="//table[hasclass('o_project_report__content')]/thead/tr[1]/th[last()]" position="after">
            <th class="text-right">Todos</th>
        </xpath>   
        <!-- Stage grouping -->  
        <xpath expr="//table[hasclass('o_project_report__content')]/tbody" position="replace">
            <tbody>
                <tr t-foreach="stage_lines" t-as="stage_line" style="background-color: #d9d8d7;">
                    <t t-set="stage" t-value="stage_line['stage']"/>
                        <td style="padding-left: 7px; font-size: 13px; font-weight: bold;">
                            <span t-raw="stage.display_name"/>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>

                        <tr t-foreach="lines" t-as="line">
                            <t t-set="project" t-value="line['project']"/>
                            <t t-if="project.stage_id == stage">
                                <td>
                                    <span t-raw="project.display_name"/>
                                </td>
                                <td class="text-right" width="10%">
                                    <span t-raw="line['date_start']" t-options="{'widget': 'date'}"/>
                                </td>
                                <td class="text-right" width="10%">
                                    <span t-raw="line['date_end']" t-options="{'widget': 'date'}"/>
                                </td>
                                <td
                                    class="text-right o_project_report__amount o_project_report__estimated_hours"
                                    t-att-project-id="project.id"
                                    >
                                    <span t-raw="line['total_estimated_hours']" t-options="{'widget': 'float_time'}"/>
                                </td>
                                <td 
                                    class="text-right o_project_report__amount o_project_report__consumed_hours"
                                    t-att-project-id="project.id"
                                    >
                                    <span t-raw="line['consumed_hours']" t-options="{'widget': 'float_time'}"/>
                                </td>
                                <td class="text-right">
                                    <span t-raw="line['budget_remaining']" t-options="{'widget': 'float_time'}"/>
                                </td>
                                <td class="text-right">
                                    <span t-raw="line['total_remaining_hours']" t-options="{'widget': 'float_time'}"/>
                                </td>
                            </t>
                        </tr>
                </tr>
                <tr class="o_project_report__totals">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td
                        class="text-right o_project_report__amount o_project_report__total_estimated_hours"
                        >
                        <span t-raw="sum(l['total_estimated_hours'] for l in lines)"
                            t-options="{'widget': 'float_time'}"/>
                    </td>
                    <td 
                        class="text-right o_project_report__amount o_project_report__total_consumed_hours"
                        >
                        <span t-raw="sum(l['consumed_hours'] for l in lines)"
                            t-options="{'widget': 'float_time'}"/>
                    </td>
                    <td class="text-right">
                        <span t-raw="sum(l['budget_remaining'] for l in lines)"
                            t-options="{'widget': 'float_time'}"/>
                    </td>
                    <td class="text-right">
                        <span t-raw="sum(l['total_remaining_hours'] for l in lines)"
                            t-options="{'widget': 'float_time'}"/>
                    </td>
                </tr>
            </tbody>
        </xpath> 
    </template>

</odoo>
