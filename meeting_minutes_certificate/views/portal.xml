<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template
        id="portal_layout"
        name="Portal layout: training certificate menu entry"
        inherit_id="portal.portal_breadcrumbs"
        priority="40"
        >
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li
                t-if="page_name == 'training_certificates'"
                t-attf-class="breadcrumb-item active"
                >
                Training Certificates
            </li>
            <li
                t-if="page_name == 'training_certificate'"
                t-attf-class="breadcrumb-item"
                >
                <a t-attf-href="/my/training-certificates?{{ keep_query() }}">
                    Training Certificates
                </a>
            </li>
            <li t-if="page_name == 'training_certificate'" class="breadcrumb-item active">
                <t t-esc="minutes.sudo().task_id.display_name"/>
            </li>
        </xpath>
    </template>

    <template
        id="portal_my_home"
        name="Portal My Home: training certificates"
        inherit_id="portal.portal_my_home"
        priority="60"
        >
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-if="training_certificates_count" t-call="portal.portal_docs_entry">
                <t t-set="title">Training Certificates</t>
                <t t-set="url" t-value="'/my/training-certificates'"/>
                <t t-set="count" t-value="training_certificates_count"/>
            </t>
        </xpath>
    </template>

    <template id="certificate_list_portal_template" name="My Training Certificates">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Training Certificates</t>
            </t>

            <t t-call="portal.portal_table">
                <thead>
                    <tr>
                        <th>Training</th>
                        <th class="text-center">Signed</th>
                    </tr>
                </thead>
                <tbody>
                    <tr t-foreach="minutes_list.sudo()" t-as="minutes">
                        <td>
                            <a t-attf-href="/my/training-certificate/#{minutes.task_id.id}?{{ keep_query() }}">
                                <span t-field="minutes.task_id.display_name"/>
                            </a>
                        </td>
                        <td class="text-center">
                            <t t-if="minutes.is_signed_by(env.user)">Yes</t>
                            <t t-else="1">No</t>
                        </td>
                    </tr>
                </tbody>
            </t>
        </t>
    </template>

    <template
        id="signature_portal_template"
        name="Certificate Signature Portal Template"
        inherit_id="portal.portal_sidebar"
        primary="True"
        >
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <t t-set="o_portal_fullwidth_alert" groups="project.group_project_user">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url"
                        t-value="'/web#model=%s&amp;id=%s&amp;view_type=form' % (minutes._name, minutes.id)"/>
                </t>
            </t>

            <div class="row mt16 o_portal_sale_sidebar">
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="entries">
                        <ul class="list-group list-group-flush flex-wrap flex-row flex-lg-column">
                            <li class="list-group-item flex-grow-1">
                                <h3>
                                    Hello <t t-raw="partner.firstname or partner.name"/>
                                </h3>
                            </li>
                            <li class="list-group-item flex-grow-1">
                                <a
                                    t-if="signature.has_to_be_signed"
                                    role="button"
                                    class="btn btn-primary btn-block mb8"
                                    data-toggle="modal"
                                    data-target="#modalsign"
                                    href="#"
                                    >
                                    Sign
                                </a>
                                <span t-else="1">
                                    Thank you!
                                    <br/>
                                    We have received your signature.
                                </span>
                            </li>
                        </ul>
                    </t>
                </t>

                <div
                    id="quote_content"
                    class="col-12 col-lg justify-content-end"
                    t-if="signature"
                    >
                    <div role="dialog" class="modal fade" id="modalsign">
                        <div class="modal-dialog">
                            <form
                                id="sign"
                                method="POST"
                                t-att-data-token="signature.access_token"
                                class="js_accept_json modal-content js_website_submit_form"
                                >
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <header class="modal-header">
                                    <h4 class="modal-title">Sign</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        &amp;times;
                                    </button>
                                </header>
                                <main class="modal-body" id="sign-dialog">
                                    <t t-call="portal.portal_signature">
                                        <t t-set="object" t-value="signature"/>
                                        <t t-set="partner_name" t-value="signature.partner_id.name"/>
                                        <t t-set="callUrl"
                                            t-value="signature.get_access_url('/sign')"
                                            />
                                        <t t-set="accessToken" t-value="signature.access_token"/>
                                    </t>
                                </main>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <object
                                t-att-data="signature.get_access_url('/report')"
                                type="application/pdf"
                                width="100%"
                                height="100%"
                                style="min-height: 800px"
                                />
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </template>


</odoo>
